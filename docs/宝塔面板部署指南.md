# NeoAI GC - Linux宝塔面板部署指南

## 目录

1. [环境准备](#1-环境准备)
2. [数据库配置](#2-数据库配置)
3. [后端部署](#3-后端部署)
4. [前端部署](#4-前端部署)
5. [部署验证](#5-部署验证)
6. [常见问题](#6-常见问题)

---

## 1. 环境准备

### 1.1 系统要求

- **操作系统**: CentOS 7+ / Ubuntu 18.04+ / Debian 9+
- **内存**: 最低2GB，推荐4GB以上
- **硬盘**: 最低20GB，推荐50GB以上
- **CPU**: 最低2核，推荐4核以上

### 1.2 安装宝塔面板

#### CentOS安装命令
```bash
yum install -y wget && wget -O install.sh http://download.bt.cn/install/install_6.0.sh && sh install.sh
```

#### Ubuntu/Debian安装命令
```bash
wget -O install.sh http://download.bt.cn/install/install-ubuntu_6.0.sh && sudo bash install.sh
```

安装完成后，会显示宝塔面板登录地址、用户名和密码，请妥善保管。

### 1.3 安装必要软件

登录宝塔面板后，在【软件商店】中安装以下软件：

1. **Nginx** (推荐版本：1.20+)
2. **MySQL** (推荐版本：5.7 或 8.0)
3. **Java Project Manager** (在应用商店搜索安装)
4. **PM2管理器** (可选，用于Node.js应用)

### 1.4 配置JDK 17

#### 方法一：通过宝塔面板安装

1. 进入【软件商店】
2. 搜索"Java"
3. 安装【Java项目管理器】
4. 在Java项目管理器中添加JDK 17
   - 下载地址：`https://download.oracle.com/java/17/latest/jdk-17_linux-x64_bin.tar.gz`
   - 或使用OpenJDK 17

#### 方法二：手动安装JDK

```bash
# 下载JDK 17
cd /usr/local
wget https://download.oracle.com/java/17/latest/jdk-17_linux-x64_bin.tar.gz

# 解压
tar -zxvf jdk-17_linux-x64_bin.tar.gz

# 配置环境变量
echo 'export JAVA_HOME=/usr/local/jdk-17' >> /etc/profile
echo 'export JRE_HOME=$JAVA_HOME/jre' >> /etc/profile
echo 'export CLASSPATH=$JAVA_HOME/lib:$JRE_HOME/lib:$CLASSPATH' >> /etc/profile
echo 'export PATH=$JAVA_HOME/bin:$JRE_HOME/bin:$PATH' >> /etc/profile

# 使配置生效
source /etc/profile

# 验证安装
java -version
```

### 1.5 开放防火墙端口

在宝塔面板【安全】设置中，开放以下端口：

| 端口 | 用途 | 说明 |
|------|------|------|
| 80 | HTTP | 前端访问 |
| 443 | HTTPS | 前端访问（可选） |
| 8080 | 后端API | Spring Boot服务 |
| 3306 | MySQL | 数据库（仅本地访问） |

---

## 2. 数据库配置

### 2.1 创建MySQL数据库

1. 登录宝塔面板
2. 进入【数据库】菜单
3. 点击【添加数据库】
4. 填写以下信息：
   - **数据库名**: `neoaigc`
   - **用户名**: `neoaigc` (或其他)
   - **密码**: 设置强密码（请记住）
   - **访问权限**: 本地服务器（127.0.0.1）

### 2.2 导入数据库表结构

#### 方法一：通过宝塔面板导入

1. 在数据库列表中找到`neoaigc`数据库
2. 点击【管理】进入phpMyAdmin
3. 选择【导入】选项卡
4. 上传项目中的`backend/init.sql`文件
5. 点击【执行】完成导入

#### 方法二：通过命令行导入

```bash
# 将项目init.sql上传到服务器
# 然后执行以下命令

mysql -u neoaigc -p neoaigc < /www/wwwroot/neoaigc/backend/init.sql
```

### 2.3 验证数据库

```bash
# 登录MySQL
mysql -u neoaigc -p

# 切换到neoaigc数据库
use neoaigc;

# 查看数据表
show tables;

# 应该看到以下表：
# - users
# - ai_tasks
# - templates
```

---

## 3. 后端部署

### 3.1 本地打包项目

在本地Windows环境中执行以下命令：

```bash
cd backend
mvn clean package -DskipTests
```

打包完成后，在`backend/target/`目录下会生成`neoaigc-backend-1.0.0.jar`文件。

### 3.2 上传文件到服务器

#### 上传jar包

1. 通过宝塔面板【文件】管理功能
2. 创建目录：`/www/wwwroot/neoaigc/backend/`
3. 将`neoaigc-backend-1.0.0.jar`上传到该目录

#### 上传配置文件

将`backend/src/main/resources/application.yml`上传到服务器，并根据生产环境修改配置：

```yaml
# 修改数据库连接信息
spring:
  datasource:
    url: jdbc:mysql://localhost:3306/neoaigc?useUnicode=true&characterEncoding=utf8&useSSL=false&serverTimezone=Asia/Shanghai&allowPublicKeyRetrieval=true
    username: neoaigc  # 改为实际的数据库用户名
    password: your_password_here  # 改为实际的数据库密码

# 修改文件上传路径
file:
  upload-path: /www/wwwroot/neoaigc/uploads  # 改为实际的上传目录

# 配置环境变量（或使用系统环境变量）
hunyuan:
  api:
    secret-id: ${HUNYUAN_SECRET_ID:your-actual-secret-id}
    secret-key: ${HUNYUAN_SECRET_KEY:your-actual-secret-key}
    region: ${HUNYUAN_REGION:ap-guangzhou}

wechat:
  app-id: ${WECHAT_APP_ID:your-actual-wechat-app-id}
  app-secret: ${WECHAT_APP_SECRET:your-actual-wechat-app-secret}
  redirect-uri: ${WECHAT_REDIRECT_URI:http://your-domain.com/api/auth/wechat/callback}

jwt:
  secret: ${JWT_SECRET:please-change-this-to-a-very-strong-secret-key}
```

### 3.3 创建系统服务（推荐）

创建systemd服务文件，实现开机自启动和进程守护：

```bash
# 创建服务文件
vim /etc/systemd/system/neoaigc-backend.service
```

添加以下内容：

```ini
[Unit]
Description=NeoAI GC Backend Service
After=network.target

[Service]
Type=simple
User=root
WorkingDirectory=/www/wwwroot/neoaigc/backend
Environment="JAVA_HOME=/usr/local/jdk-17"
Environment="HUNYUAN_SECRET_ID=your-secret-id"
Environment="HUNYUAN_SECRET_KEY=your-secret-key"
Environment="WECHAT_APP_ID=your-wechat-app-id"
Environment="WECHAT_APP_SECRET=your-wechat-app-secret"
Environment="JWT_SECRET=your-jwt-secret"
ExecStart=/usr/local/jdk-17/bin/java -jar /www/wwwroot/neoaigc/backend/neoaigc-backend-1.0.0.jar
ExecStop=/bin/kill -15 $MAINPID
Restart=on-failure
RestartSec=10

[Install]
WantedBy=multi-user.target
```

### 3.4 启动后端服务

```bash
# 重新加载systemd配置
systemctl daemon-reload

# 启动服务
systemctl start neoaigc-backend

# 设置开机自启
systemctl enable neoaigc-backend

# 查看服务状态
systemctl status neoaigc-backend

# 查看日志
journalctl -u neoaigc-backend -f
```

### 3.5 验证后端服务

```bash
# 检查端口是否监听
netstat -tlnp | grep 8080

# 或使用ss命令
ss -tlnp | grep 8080

# 测试API接口
curl http://localhost:8080/api/auth/wechat/qr-code
```

---

## 4. 前端部署

### 4.1 上传前端文件

1. 通过宝塔面板【文件】管理功能
2. 创建目录：`/www/wwwroot/neoaigc/frontend/`
3. 将`frontend-cdn`目录下的所有文件上传到该目录

**上传的文件包括：**
- `index.html`
- `js/app.js`
- `js/components/*.js`
- `css/*.css`
- `assets/*` (如果有)

### 4.2 修改API配置

修改`/www/wwwroot/neoaigc/frontend/js/app.js`文件中的API_BASE：

```javascript
// 修改前
const API_BASE = 'http://localhost:8080/api';

// 修改后（使用您的域名或IP）
const API_BASE = 'http://your-domain.com/api';
// 或使用相对路径（推荐，避免跨域问题）
const API_BASE = '/api';
```

### 4.3 创建Nginx站点

#### 方法一：通过宝塔面板创建（推荐）

1. 进入宝塔面板【网站】菜单
2. 点击【添加站点】
3. 填写以下信息：
   - **域名**: 填写您的域名（如：`neoaigc.example.com`）
   - **根目录**: `/www/wwwroot/neoaigc/frontend`
   - **PHP版本**: 纯静态（无需PHP）
   - **创建FTP**: 不创建
   - **创建数据库**: 不创建
4. 点击【提交】

#### 方法二：手动创建Nginx配置

```bash
# 创建Nginx配置文件
vim /www/server/panel/vhost/nginx/neoaigc.conf
```

添加以下内容：

```nginx
server {
    listen 80;
    server_name your-domain.com;  # 修改为您的域名

    root /www/wwwroot/neoaigc/frontend;
    index index.html;

    # 前端静态文件
    location / {
        try_files $uri $uri/ /index.html;
    }

    # 反向代理到后端API
    location /api {
        proxy_pass http://127.0.0.1:8080;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # WebSocket支持（如果需要）
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";

        # 超时设置
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
    }

    # 文件上传大小限制
    client_max_body_size 100M;

    # 静态资源缓存
    location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$ {
        expires 30d;
        add_header Cache-Control "public, immutable";
    }

    # 禁止访问敏感文件
    location ~ /\. {
        deny all;
    }
}
```

### 4.4 配置HTTPS（可选但推荐）

#### 使用宝塔面板SSL证书

1. 进入宝塔面板【网站】菜单
2. 找到您的站点，点击【设置】
3. 选择【SSL】选项卡
4. 选择【Let's Encrypt】免费证书
5. 填写邮箱，勾选域名
6. 点击【申请】

#### 手动配置SSL（如果有自己的证书）

```nginx
server {
    listen 443 ssl http2;
    server_name your-domain.com;

    ssl_certificate /path/to/your/cert.pem;
    ssl_certificate_key /path/to/your/key.pem;

    # SSL优化配置
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers HIGH:!aNULL:!MD5;
    ssl_prefer_server_ciphers on;
    ssl_session_cache shared:SSL:10m;
    ssl_session_timeout 10m;

    # 其他配置同HTTP
    root /www/wwwroot/neoaigc/frontend;
    # ... 其他配置
}

# HTTP自动跳转HTTPS
server {
    listen 80;
    server_name your-domain.com;
    return 301 https://$server_name$request_uri;
}
```

### 4.5 重载Nginx配置

```bash
# 测试Nginx配置
nginx -t

# 重载Nginx
nginx -s reload

# 或通过宝塔面板重载
# 网站 -> 设置 -> 配置文件 -> 保存
```

---

## 5. 部署验证

### 5.1 检查后端服务

```bash
# 查看后端服务状态
systemctl status neoaigc-backend

# 查看后端日志
journalctl -u neoaigc-backend -f

# 测试API接口
curl http://localhost:8080/api/auth/wechat/qr-code
```

### 5.2 检查Nginx服务

```bash
# 查看Nginx状态
systemctl status nginx

# 查看Nginx错误日志
tail -f /www/wwwlogs/neoaigc.com.error.log

# 查看Nginx访问日志
tail -f /www/wwwlogs/neoaigc.com.access.log
```

### 5.3 浏览器测试

1. **访问前端页面**
   - 打开浏览器，访问：`http://your-domain.com`
   - 应该能看到NeoAI GC的登录界面

2. **测试微信登录**
   - 点击微信登录按钮
   - 检查是否正确显示二维码

3. **测试API接口**
   - 打开浏览器开发者工具（F12）
   - 查看Network选项卡
   - 测试功能时检查API请求是否成功

4. **测试文件上传**
   - 尝试上传图片
   - 检查上传目录：`/www/wwwroot/neoaigc/uploads/`

### 5.4 性能测试

```bash
# 使用Apache Bench测试
ab -n 1000 -c 100 http://your-domain.com/

# 查看系统资源使用
htop

# 查看磁盘空间
df -h

# 查看内存使用
free -h
```

---

## 6. 常见问题

### 6.1 后端无法启动

**问题**: 执行`systemctl start neoaigc-backend`失败

**解决方法**:

1. 检查Java版本
```bash
java -version
# 应该显示 Java 17
```

2. 查看详细日志
```bash
journalctl -u neoaigc-backend -n 50 --no-pager
```

3. 检查端口占用
```bash
netstat -tlnp | grep 8080
```

4. 检查数据库连接
```bash
mysql -u neoaigc -p neoaigc
```

### 6.2 前端访问404

**问题**: 访问域名显示404错误

**解决方法**:

1. 检查Nginx配置文件路径是否正确
```bash
ls -la /www/wwwroot/neoaigc/frontend/
```

2. 检查Nginx配置
```bash
nginx -t
```

3. 查看Nginx错误日志
```bash
tail -f /www/wwwlogs/neoaigc.com.error.log
```

### 6.3 跨域问题

**问题**: 前端无法调用后端API

**解决方法**:

1. 确认Nginx反向代理配置正确
2. 在后端添加CORS支持（已在代码中配置）
3. 使用相对路径：`/api` 而不是 `http://localhost:8080/api`

### 6.4 文件上传失败

**问题**: 文件上传时提示错误

**解决方法**:

1. 检查上传目录权限
```bash
chmod -R 755 /www/wwwroot/neoaigc/uploads
chown -R www:www /www/wwwroot/neoaigc/uploads
```

2. 检查Nginx上传限制
```nginx
client_max_body_size 100M;
```

3. 检查Spring Boot配置
```yaml
spring:
  servlet:
    multipart:
      max-file-size: 50MB
      max-request-size: 100MB
```

### 6.5 数据库连接失败

**问题**: 后端日志显示数据库连接错误

**解决方法**:

1. 检查MySQL服务状态
```bash
systemctl status mysqld
```

2. 检查数据库用户权限
```sql
GRANT ALL PRIVILEGES ON neoaigc.* TO 'neoaigc'@'localhost';
FLUSH PRIVILEGES;
```

3. 检查防火墙
```bash
# 确保MySQL端口允许本地访问
firewall-cmd --list-ports
```

### 6.6 服务重启后丢失配置

**问题**: 重启服务器后服务没有自动启动

**解决方法**:

```bash
# 检查开机自启状态
systemctl is-enabled neoaigc-backend

# 如果未启用，执行
systemctl enable neoaigc-backend
systemctl enable nginx
systemctl enable mysqld
```

### 6.7 性能优化建议

**后端优化**:

1. 增加JVM堆内存
```ini
[Service]
ExecStart=/usr/local/jdk-17/bin/java -Xms512m -Xmx2g -jar ...
```

2. 配置数据库连接池（已在application.yml中配置）

**Nginx优化**:

```nginx
worker_processes auto;
worker_connections 2048;

# 启用Gzip压缩
gzip on;
gzip_vary on;
gzip_min_length 1024;
gzip_types text/plain text/css text/xml text/javascript application/x-javascript application/xml+rss application/json;
```

### 6.8 安全加固建议

1. **修改默认端口**
   - 修改Spring Boot端口为随机端口
   - 仅通过Nginx反向代理访问

2. **配置防火墙**
```bash
# 仅开放80和443端口
firewall-cmd --add-service=http --permanent
firewall-cmd --add-service=https --permanent
firewall-cmd --reload
```

3. **定期备份数据**
```bash
# 创建备份脚本
vim /www/backup/backup.sh
```

```bash
#!/bin/bash
BACKUP_DIR="/www/backup"
DATE=$(date +%Y%m%d_%H%M%S)

# 备份数据库
mysqldump -u neoaigc -p'password' neoaigc > $BACKUP_DIR/neoaigc_$DATE.sql

# 备份上传文件
tar -czf $BACKUP_DIR/uploads_$DATE.tar.gz /www/wwwroot/neoaigc/uploads

# 删除30天前的备份
find $BACKUP_DIR -name "*.sql" -mtime +30 -delete
find $BACKUP_DIR -name "*.tar.gz" -mtime +30 -delete
```

4. **配置定时任务**
```bash
# 编辑crontab
crontab -e

# 每天凌晨2点执行备份
0 2 * * * /www/backup/backup.sh
```

---

## 7. 联系与支持

如果在部署过程中遇到问题，请：

1. 查看项目文档：`README.md`
2. 检查日志文件：
   - 后端日志：`journalctl -u neoaigc-backend -f`
   - Nginx日志：`/www/wwwlogs/`
3. 提交Issue到项目仓库

---

**部署完成后，请及时修改所有默认密码和密钥！**

**文档版本**: 1.0.0
**最后更新**: 2026-01-12
